{% extends "base.html" %}

{% block title %}Cuestionario Semanal - Seguimiento Familiar{% endblock %}

{% block content %}
<div
    style="max-width: 800px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h2 style="color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 1rem; margin-bottom: 2rem;">Seguimiento
        Semanal del Alumno</h2>

    <div
        style="background-color: #f8f9fa; padding: 1rem; border-left: 4px solid #007bff; margin-bottom: 2rem; border-radius: 4px;">
        <p style="margin: 0; color: #555;">Por favor, responda con sinceridad basándose en lo observado durante la
            última semana. Sus respuestas son confidenciales y ayudan a proteger el bienestar de su hijo/a.</p>
    </div>

    <form id="survey-form">
        <!-- Sección A: Salud Física -->
        <fieldset style="border: none; margin-bottom: 2rem;">
            <legend style="font-weight: bold; font-size: 1.2rem; margin-bottom: 1rem; color: #34495e;">A. Indicadores
                Físicos</legend>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">¿Ha manifestado dolores de
                    cabeza o malestar físico antes de ir al colegio (sin causa médica)?</label>
                <select name="headache_stomach" required
                    style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                    <option value="" disabled selected>Seleccione una opción...</option>
                    <option value="nunca">Nunca</option>
                    <option value="a_veces">A veces</option>
                    <option value="a_menudo">A menudo</option>
                    <option value="siempre">Siempre</option>
                </select>
            </div>
        </fieldset>

        <!-- Sección B: Cambios Emocionales -->
        <fieldset style="border: none; margin-bottom: 2rem;">
            <legend style="font-weight: bold; font-size: 1.2rem; margin-bottom: 1rem; color: #34495e;">B. Cambios
                Conductuales</legend>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">¿Ha notado cambios bruscos de
                    humor, irritabilidad o tristeza al volver de clase?</label>
                <select name="mood_changes" required
                    style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                    <option value="" disabled selected>Seleccione una opción...</option>
                    <option value="nunca">Nunca</option>
                    <option value="a_veces">A veces</option>
                    <option value="a_menudo">A menudo</option>
                    <option value="siempre">Siempre</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">¿Tiene dificultades para dormir
                    o pesadillas?</label>
                <select name="sleep_problems" required
                    style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                    <option value="" disabled selected>Seleccione una opción...</option>
                    <option value="nunca">Nunca</option>
                    <option value="a_veces">A veces</option>
                    <option value="a_menudo">A menudo</option>
                    <option value="siempre">Siempre</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">¿Muestra resistencia o ansiedad
                    explícita a la hora de ir al colegio?</label>
                <select name="school_resistance" required
                    style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                    <option value="" disabled selected>Seleccione una opción...</option>
                    <option value="nunca">Nunca</option>
                    <option value="a_veces">A veces</option>
                    <option value="a_menudo">A menudo</option>
                    <option value="siempre">Siempre</option>
                </select>
            </div>
        </fieldset>

        <!-- Sección C: Alertas Directas -->
        <fieldset style="border: none; margin-bottom: 2rem;">
            <legend style="font-weight: bold; font-size: 1.2rem; margin-bottom: 1rem; color: #e74c3c;">C. Alertas
                Directas</legend>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">¿Ha llegado a casa con material
                    escolar roto, perdido o ropa estropeada?</label>
                <div style="display: flex; gap: 1rem;">
                    <label><input type="radio" name="damaged_items" value="si" required> Sí</label>
                    <label><input type="radio" name="damaged_items" value="no"> No</label>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">¿Ha verbalizado algún conflicto
                    con compañeros?</label>
                <div style="display: flex; gap: 1rem;">
                    <label><input type="radio" name="conflict_verbalized" value="si" required> Sí</label>
                    <label><input type="radio" name="conflict_verbalized" value="no"> No</label>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Si contestó Sí, ¿puede dar
                    detalles breves?</label>
                <textarea name="conflict_details"
                    style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 6px; min-height: 80px;"></textarea>
            </div>
        </fieldset>

        <button type="submit"
            style="width: 100%; padding: 1rem; background-color: #2ecc71; color: white; border: none; border-radius: 6px; font-size: 1.1rem; cursor: pointer; transition: background 0.3s;">
            Enviar Informe Semanal
        </button>
    </form>
</div>

<script>
    document.getElementById('survey-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Recoger datos del formulario
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        // Obtener IDs de la URL (Pasados desde el Dashboard)
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('student_id');

        if (!studentId) {
            alert("Error: Faltan identificadores de alumno.");
            return;
        }

        try {
            const response = await fetch(`/surveys/api/submit?student_id=${studentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();
                alert('Informe enviado correctamente.\nGracias por su colaboración.');
                window.location.href = '/parents/dashboard';
            } else {
                alert('Hubo un error al enviar el informe.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión.');
        }
    });
</script>
{% endblock %}