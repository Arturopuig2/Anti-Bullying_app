{% extends "base.html" %}

{% block title %}Panel de Director - {{ school.name }}{% endblock %}

{% block content %}
<div style="padding: 2rem; max-width: 1200px; margin: 0 auto;">

    <header style="margin-bottom: 2rem;">
        <h1 style="color: #2c3e50;">Panel de Direcci贸n: {{ school.name }}</h1>
        <p style="color: #7f8c8d;">Visi贸n general del estado de convivencia del centro.</p>
    </header>

    <!-- Top Stats Cards -->
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">

        <!-- Total Alumnos -->
        <div
            style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #3498db;">
            <h3 style="margin: 0; color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase;">Total Alumnos / as</h3>
            <p style="margin: 0.5rem 0 0; font-size: 2.5rem; font-weight: 700; color: #2c3e50;">{{ total_students }}</p>
        </div>

        <!-- Alertas Activas -->
        <div
            style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #e74c3c;">
            <h3 style="margin: 0; color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase;">Alertas Graves</h3>
            <p style="margin: 0.5rem 0 0; font-size: 2.5rem; font-weight: 700; color: #e74c3c;">{{ total_alerts }}</p>
        </div>

        <!-- Estado del Centro -->
        <div
            style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid {% if school_color == 'red' %}#e74c3c{% elif school_color == 'orange' %}#f39c12{% else %}#2ecc71{% endif %};">
            <h3 style="margin: 0; color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase;">Estado del Centro</h3>
            <p
                style="margin: 0.5rem 0 0; font-size: 1.5rem; font-weight: 700; color: {% if school_color == 'red' %}#e74c3c{% elif school_color == 'orange' %}#f39c12{% else %}#2ecc71{% endif %};">
                {{ school_status }}
            </p>
        </div>
    </div>

    <!-- Tabla de Aulas -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="color: #2c3e50; margin: 0;">Aulas</h2>
        <div style="display: flex; gap: 10px;">
            <select id="filter-status" onchange="filterClassrooms()"
                style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                <option value="">Todos los Estados</option>
                <option value="CRTICO"> Cr铆tico</option>
                <option value="PRECAUCIN"> Precauci贸n</option>
                <option value="SALUDABLE"> Saludable</option>
            </select>
            <input type="text" id="classroomSearch" onkeyup="filterClassrooms()" placeholder=" Buscar aula..."
                style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
        </div>
    </div>

    <div style="background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden;">
        <table id="classroomsTable" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; text-align: left;">
                    <th style="padding: 1rem; border-bottom: 2px solid #eee; color: #7f8c8d; cursor: pointer;"
                        onclick="sortTable(0, 'text')">C贸digo Aula 锔</th>
                    <th style="padding: 1rem; border-bottom: 2px solid #eee; color: #7f8c8d; cursor: pointer;"
                        onclick="sortTable(1, 'number')">Alumnos / as 锔</th>
                    <th style="padding: 1rem; border-bottom: 2px solid #eee; color: #7f8c8d; cursor: pointer;"
                        onclick="sortTable(2, 'number')">Alertas 锔</th>
                    <th style="padding: 1rem; border-bottom: 2px solid #eee; color: #7f8c8d;">Estado Salud</th>
                    <th style="padding: 1rem; border-bottom: 2px solid #eee; color: #7f8c8d;">Acci贸n</th>
                </tr>
            </thead>
            <tbody>
                {% for classroom in classrooms %}
                <tr class="classroom-row"
                    style="border-bottom: 1px solid #eee; transition: background 0.2s; cursor: pointer;"
                    onclick="window.location.href='/dashboard/school_admin/classroom/{{ classroom.name }}{{ '?school_id=' ~ school.id if user.role.value == 'super_admin' else '' }}'">
                    <td style="padding: 1rem; font-weight: 600; color: #2c3e50;">
                        <span class="classroom-name">{{ classroom.name }}</span>
                        {% if classroom.has_critical %}
                        <span
                            style="display: inline-block; width: 8px; height: 8px; background-color: #e74c3c; border-radius: 50%; margin-left: 5px; vertical-align: middle;"
                            title="Caso cr铆tico activo"></span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem; color: #555;">
                        {{ classroom.student_count }}
                    </td>
                    <td style="padding: 1rem;">
                        {% if classroom.alerts_count > 0 %}
                        <span
                            style="background: #fadbd8; color: #c0392b; padding: 0.2rem 0.6rem; border-radius: 12px; font-weight: 600; font-size: 0.9rem;">
                            {{ classroom.alerts_count }} activas
                        </span>
                        {% else %}
                        <span style="color: #95a5a6;">0</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem;">
                        <span class="status-text">
                            {% if classroom.status == 'red' %}
                            <span style="color: #c0392b; font-weight: bold;"> Cr铆tico</span>
                            {% elif classroom.status == 'orange' %}
                            <span style="color: #d35400; font-weight: bold;"> Precauci贸n</span>
                            {% else %}
                            <span style="color: #27ae60; font-weight: bold;"> Saludable</span>
                            {% endif %}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <a href="/dashboard/school_admin/classroom/{{ classroom.name }}{{ '?school_id=' ~ school.id if user.role.value == 'super_admin' else '' }}"
                            style="color: #3498db; text-decoration: none; font-weight: 500;">
                            Ver Detalle &rarr;
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function filterClassrooms() {
        const searchInput = document.getElementById('classroomSearch').value.toUpperCase();
        const statusFilter = document.getElementById('filter-status').value.toUpperCase();

        const rows = document.getElementsByClassName("classroom-row");

        for (let i = 0; i < rows.length; i++) {
            const name = rows[i].querySelector(".classroom-name").textContent.toUpperCase();
            const statusText = rows[i].querySelector(".status-text").textContent.toUpperCase();

            let visible = true;

            if (searchInput && name.indexOf(searchInput) === -1) {
                visible = false;
            }

            if (statusFilter && statusText.indexOf(statusFilter) === -1) {
                visible = false;
            }

            rows[i].style.display = visible ? "" : "none";
        }
    }

    let sortDir = {};
    function sortTable(n, type) {
        let table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("classroomsTable");
        switching = true;

        dir = sortDir[n] === "asc" ? "desc" : "asc";
        sortDir[n] = dir;

        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];

                let xVal = x.textContent.trim();
                let yVal = y.textContent.trim();

                if (type === 'number') {
                    // Extract just the number (e.g. "5 activas" -> 5)
                    xVal = parseInt(xVal) || 0;
                    yVal = parseInt(yVal) || 0;
                }

                if (dir == "asc") {
                    if (xVal > yVal) { shouldSwitch = true; break; }
                } else if (dir == "desc") {
                    if (xVal < yVal) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            }
        }
    }
</script>
{% endblock %}