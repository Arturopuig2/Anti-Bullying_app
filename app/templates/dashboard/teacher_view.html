{% extends "base.html" %}

{% block title %}Panel del Profesor - Hub de Monitorizaci√≥n{% endblock %}

{% block content %}
<div style="padding: 2rem; max-width: 1200px; margin: 0 auto;">

    <header style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="color: #2c3e50; margin: 0;">Panel de Monitorizaci√≥n</h1>
            <p style="color: #7f8c8d; margin-top: 0.5rem;">Vista general del estado emocional del aula</p>
        </div>
        <div>

            <span
                style="background: #eef2f7; color: #2c3e50; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 500;">
                Profesor: {{ user.full_name }}
            </span>
        </div>
    </header>

    <!-- Tarjetas de Resumen -->
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- Card 0: C√≥digo de Aula -->
        <div
            style="background: linear-gradient(135deg, #f39c12, #d35400); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; font-size: 1rem; opacity: 0.9;">C√≥digo de Aula</h3>
            <p style="margin: 0.5rem 0 0 0; font-size: 2rem; font-weight: bold; letter-spacing: 2px;">{{
                teacher.teacher_code }}</p>
            <small style="opacity: 0.8; font-size: 0.8rem;">Comp√°rtelo con los padres</small>
        </div>

        {% if teacher.school %}
        <!-- Card 0.5: Mi Colegio -->
        <div
            style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; font-size: 1rem; opacity: 0.9;">Mi Colegio</h3>
            <p style="margin: 0.5rem 0 0 0; font-size: 1.4rem; font-weight: bold;">{{ teacher.school.center_code }}</p>
            <small
                style="opacity: 0.8; font-size: 0.8rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{
                teacher.school.name }}</small>
        </div>
        {% endif %}

        <!-- Total Students -->
        <div
            style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #3498db;">
            <h3 style="margin: 0; color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase;">Total Alumnos / as</h3>
            <p style="margin: 0.5rem 0 0; font-size: 2.5rem; font-weight: 700; color: #2c3e50;">{{ total_students }}</p>
        </div>

        <!-- Card 2 -->
        <div
            style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid #e74c3c;">
            <h3 style="margin: 0; font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase;">Alertas Activas</h3>
            <p style="font-size: 2rem; font-weight: bold; margin: 0.5rem 0 0 0; color: #e74c3c;">{{ critical_count }}
            </p>
        </div>

        <!-- Card 3 -->
        <div
            style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid #2ecc71;">
            <h3 style="margin: 0; font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase;">Estado Saludable</h3>
            <p style="font-size: 2rem; font-weight: bold; margin: 0.5rem 0 0 0; color: #27ae60;">{{ healthy_percentage
                }}%</p>
        </div>
    </div>

    <!-- Secci√≥n de Alertas Cr√≠ticas -->
    {% if alerts %}
    <section style="margin-bottom: 3rem;">
        <h2
            style="font-size: 1.4rem; color: #c0392b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            ‚ö†Ô∏è Requieren Atenci√≥n Inmediata
        </h2>
        <div style="display: grid; gap: 1rem;">
            {% for alert in alerts %}
            <div
                style="background: #fff5f5; border: 1px solid #feb2b2; padding: 1.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h4 style="margin: 0 0 0.5rem 0; color: #c53030;">Alumno: {{ alert.student.name if
                        alert.student.name else alert.student.internal_code }}</h4>
                    <p style="margin: 0; color: #742a2a; font-size: 0.95rem;">
                        <strong>Motivo:</strong> {{ alert.ai_summary }}
                    </p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #9b2c2c;">
                        Detectado: {{ alert.date_submitted.strftime('%d/%m/%Y %H:%M') }}
                    </p>
                </div>
                <a href="/dashboard/case/{{ alert.id }}"
                    style="background: #c53030; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; text-decoration: none;">
                    Ver Caso
                </a>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Actividad Reciente Tabla -->
    <section>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="font-size: 1.4rem; color: #2c3e50; margin: 0;">Actividad Reciente</h2>
            <input type="text" id="globalSearch" onkeyup="filterGlobal()" placeholder="üîç Buscar..."
                style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
        </div>

        <div style="background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden;">
            <table id="teacherTable" style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f8f9fa;">
                    <tr>
                        <!-- Fecha: Ordenar -->
                        <th style="padding: 1rem; text-align: left; color: #6c757d; font-weight: 600; cursor: pointer;"
                            onclick="sortTable(0, 'date')">
                            Fecha <span id="sort-0">‚ÜïÔ∏è</span>
                        </th>

                        <!-- Alumno: Filtro + Orden -->
                        <th style="padding: 1rem; text-align: left; color: #6c757d; font-weight: 600;">
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <span style="cursor: pointer;" onclick="sortTable(1, 'text')">Alumno <span
                                        id="sort-1">‚ÜïÔ∏è</span></span>
                                <select id="filter-student" onchange="filterTable()"
                                    style="padding: 2px; font-size: 0.8rem;">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                        </th>

                        <!-- Nivel Riesgo: Filtro + Orden -->
                        <th style="padding: 1rem; text-align: left; color: #6c757d; font-weight: 600;">
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <span style="cursor: pointer;" onclick="sortTable(2, 'risk')">Riesgo <span
                                        id="sort-2">‚ÜïÔ∏è</span></span>
                                <select id="filter-risk" onchange="filterTable()"
                                    style="padding: 2px; font-size: 0.8rem;">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                        </th>

                        <!-- Score: Filtro + Orden -->
                        <th style="padding: 1rem; text-align: left; color: #6c757d; font-weight: 600;">
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <span style="cursor: pointer;" onclick="sortTable(3, 'number')">Score <span
                                        id="sort-3">‚ÜïÔ∏è</span></span>
                                <select id="filter-score" onchange="filterTable()"
                                    style="padding: 2px; font-size: 0.8rem;">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                        </th>

                        <th style="padding: 1rem; text-align: left; color: #6c757d; font-weight: 600;">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in activity %}
                    <tr class="data-row" style="border-bottom: 1px solid #eee;">
                        <td style="padding: 1rem;" data-sort="{{ item.date_submitted.isoformat() }}">
                            {{ item.date_submitted.strftime('%d/%m %H:%M') }}
                        </td>
                        <td style="padding: 1rem; font-weight: 500;">
                            {{ item.student.name if item.student.name else item.student.internal_code }}
                        </td>
                        <td style="padding: 1rem;">
                            {% if item.risk_level.value == 'critical' %}
                            <span
                                style="background: #fed7d7; color: #c53030; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">CR√çTICO</span>
                            {% elif item.risk_level.value == 'high' %}
                            <span
                                style="background: #feebc8; color: #dd6b20; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">ALTO</span>
                            {% elif item.risk_level.value == 'medium' %}
                            <span
                                style="background: #fefcbf; color: #b7791f; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">MEDIO</span>
                            {% else %}
                            <span
                                style="background: #c6f6d5; color: #2f855a; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">NORMAL</span>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem;">{{ item.calculated_risk_score }}</td>
                        <td style="padding: 1rem;">
                            <a href="/dashboard/case/{{ item.id }}"
                                style="color: #3182ce; text-decoration: none;">Detalles &rarr;</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
            <div style="color: #7f8c8d; font-size: 0.9rem;">
                Mostrando <span id="startRange">0</span>-<span id="endRange">0</span> de <span id="totalRows">0</span>
                registros
            </div>
            <div style="display: flex; gap: 5px;">
                <button onclick="changePage(-1)" id="prevBtn"
                    style="padding: 0.5rem 1rem; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Anterior</button>
                <span id="pageIndicator"
                    style="display: flex; align-items: center; padding: 0 10px; font-weight: 600; color: #2c3e50;">P√°gina
                    1</span>
                <button onclick="changePage(1)" id="nextBtn"
                    style="padding: 0.5rem 1rem; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Siguiente</button>
            </div>
        </div>
    </section>
</div>

<script>
    let currentPage = 1;
    const rowsPerPage = 20;
    let filteredRows = []; // Stores the actual rows (DOM elements) that match the filters

    document.addEventListener('DOMContentLoaded', function () {
        populateFilters(1, 'filter-student');
        populateFilters(2, 'filter-risk');
        populateFilters(3, 'filter-score');

        // Initial setup: all rows are "filtered" (visible)
        const table = document.getElementById("teacherTable");
        const tbody = table.querySelector("tbody");
        const allRows = Array.from(tbody.getElementsByClassName("data-row"));

        // Save references in a custom property on the row if needed, or just use array
        // But logic is: Filter -> Update filteredRows -> Paginate -> Show/Hide

        // Initial run
        applyFilters();
    });

    function populateFilters(colIndex, selectId) {
        const table = document.getElementById("teacherTable");
        const rows = table.getElementsByClassName("data-row");
        const select = document.getElementById(selectId);
        const uniqueValues = new Set();

        for (let i = 0; i < rows.length; i++) {
            let cell = rows[i].getElementsByTagName("td")[colIndex];
            if (cell) {
                uniqueValues.add(cell.textContent.trim());
            }
        }

        const sortedValues = Array.from(uniqueValues).sort();
        sortedValues.forEach(val => {
            const option = document.createElement("option");
            option.value = val;
            option.text = val;
            select.appendChild(option);
        });
    }

    // Called when selects change or search input changes
    function filterTable() {
        currentPage = 1; // Reset to page 1 on filter change
        applyFilters();
    }

    function filterGlobal() {
        currentPage = 1;
        applyFilters();
    }

    function applyFilters() {
        const studentFilter = document.getElementById('filter-student').value.toUpperCase();
        const riskFilter = document.getElementById('filter-risk').value.toUpperCase();
        const scoreFilter = document.getElementById('filter-score').value.toUpperCase();
        const globalFilter = document.getElementById('globalSearch').value.toUpperCase();

        const table = document.getElementById("teacherTable");
        const allRows = Array.from(table.getElementsByClassName("data-row"));

        // 1. Determine which rows match
        filteredRows = allRows.filter(row => {
            const studentText = row.getElementsByTagName("td")[1].textContent.trim().toUpperCase();
            const riskText = row.getElementsByTagName("td")[2].textContent.trim().toUpperCase();
            const scoreText = row.getElementsByTagName("td")[3].textContent.trim().toUpperCase();

            let matches = true;
            if (studentFilter && studentText !== studentFilter) matches = false;
            if (riskFilter && riskText !== riskFilter) matches = false;
            if (scoreFilter && scoreText !== scoreFilter) matches = false;

            if (globalFilter && studentText.indexOf(globalFilter) === -1) matches = false;

            return matches;
        });

        // 2. Render current page
        renderPage();
    }

    function renderPage() {
        const total = filteredRows.length;
        const totalPages = Math.ceil(total / rowsPerPage) || 1;

        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        // Hide ALL rows first (simplest approach, or toggle display)
        const table = document.getElementById("teacherTable");
        const allRows = table.getElementsByClassName("data-row");
        for (let row of allRows) {
            row.style.display = "none";
        }

        // Calculate slice
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, total);

        // Show only rows in slice
        for (let i = startIndex; i < endIndex; i++) {
            filteredRows[i].style.display = "";
        }

        // Update UI info
        document.getElementById("startRange").textContent = total > 0 ? startIndex + 1 : 0;
        document.getElementById("endRange").textContent = endIndex;
        document.getElementById("totalRows").textContent = total;
        document.getElementById("pageIndicator").textContent = "P√°gina " + currentPage + " de " + totalPages;

        // Button states
        document.getElementById("prevBtn").disabled = (currentPage === 1);
        document.getElementById("prevBtn").style.opacity = (currentPage === 1) ? "0.5" : "1";

        document.getElementById("nextBtn").disabled = (currentPage === totalPages);
        document.getElementById("nextBtn").style.opacity = (currentPage === totalPages) ? "0.5" : "1";
    }

    function changePage(delta) {
        currentPage += delta;
        renderPage();
    }

    // Sort logic needs to re-apply filter/sort to filteredRows? 
    // Ideally sorting rearranges the DOM nodes, so applyFilters() will pick them up in new order?
    // Let's modify sortTable to just sort DOM nodes and refilter.

    let sortDirections = {};
    function sortTable(n, type) {
        const table = document.getElementById("teacherTable");
        const tbody = table.querySelector("tbody");
        let rows = Array.from(tbody.getElementsByClassName("data-row"));

        let dir = sortDirections[n] === "asc" ? "desc" : "asc";
        sortDirections[n] = dir;

        document.querySelectorAll('[id^="sort-"]').forEach(el => el.textContent = '‚ÜïÔ∏è');
        document.getElementById('sort-' + n).textContent = dir === 'asc' ? '‚Üë' : '‚Üì';

        rows.sort((a, b) => {
            let x = a.getElementsByTagName("TD")[n].textContent.trim();
            let y = b.getElementsByTagName("TD")[n].textContent.trim();

            if (type === 'date') {
                x = a.getElementsByTagName("TD")[n].getAttribute('data-sort') || x;
                y = b.getElementsByTagName("TD")[n].getAttribute('data-sort') || y;
            }
            if (type === 'number') {
                x = parseFloat(x) || 0;
                y = parseFloat(y) || 0;
            } else {
                x = x.toLowerCase();
                y = y.toLowerCase();
            }

            if (x < y) return dir === 'asc' ? -1 : 1;
            if (x > y) return dir === 'asc' ? 1 : -1;
            return 0;
        });

        // Re-append rows in new order
        rows.forEach(row => tbody.appendChild(row));

        // Re-apply filters/pagination to reflect order
        applyFilters();
    }
</script>
{% endblock %}